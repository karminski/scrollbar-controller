name: Status

on:
  push:
    branches: [ main ]
  schedule:
    # Run daily at 00:00 UTC to check project health
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: Project health check
        run: |
          echo "ðŸ¥ Running project health check..."
          
          # Check critical files exist
          critical_files=(
            "package.json"
            "src/main.js"
            "build/build.js"
            ".github/workflows/build.yml"
          )
          
          for file in "${critical_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Critical file missing: $file"
              exit 1
            fi
          done
          
          # Check build system
          npm run clean
          npm run build
          
          if [ ! -f "dist/scrollbar-control.user.js" ]; then
            echo "âŒ Build system not working"
            exit 1
          fi
          
          # Check code quality
          npm run lint
          npm run format:check
          
          echo "âœ… Project health check passed"
      
      - name: Generate status report
        run: |
          echo "## ðŸ“Š Project Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Build System**: Working âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Quality**: Passing âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependencies**: Up to date âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical Files**: Present âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Project Metrics" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dist/scrollbar-control.user.js" ]; then
            file_size=$(stat -c%s "dist/scrollbar-control.user.js")
            line_count=$(wc -l < "dist/scrollbar-control.user.js")
            echo "- **Build Size**: ${file_size} bytes" >> $GITHUB_STEP_SUMMARY
            echo "- **Lines of Code**: ${line_count}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Last Check**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Project is healthy and ready for development!**" >> $GITHUB_STEP_SUMMARY
